!function(){var mac=/Mac/.test(navigator.platform),win=/Win/.test(navigator.platform),Event={on:function(el,type,handler,disconnect){return el.addEventListener(type,handler,!1),disconnect?function(){el.removeEventListener(type,handler,!1)}:void 0},off:function(el,type,handler){el.removeEventListener(type,handler,!1)},preventDefault:function(e){e.preventDefault()},stopPropagation:function(e){e.stopPropagation()},stop:function(e){Event.preventDefault(e),Event.stopPropagation(e)}};String.prototype.splice=function(i,remove,add){return remove=+remove||0,add=add||"",this.slice(0,i)+add+this.slice(i+remove)};var Extend=function(destination,source){for(var property in source)destination[property]=source[property];return destination},Range={copy:function(position){return{line:position.line,ch:position.ch,x:position.x,y:position.y}},equal:function(from,to){return from.line===to.line&&from.ch===to.ch},line:function(from,to){return from.line===to.line},less:function(from,to){return from.line<to.line||from.line==to.line&&from.ch<to.ch},isWordChar:function(ch){return/\w/.test(ch)||ch.toUpperCase()!=ch.toLowerCase()}},Editor=function(lines,options){this.options={localStorage:"content",max_line:64,padding_length:6,smartTypingPairs:!0,smartNewline:!0},Extend(this.options,options),this.tag_container="p",this.mark_container="mark",this.line_height=32,this.em_width=13,this.width=832,this.padding=156,this.tab_width=64,this.focused=null,this.lastDoubleClick=null,this.lastClick=null,this.focusmode=null,this.shiftSelecting=null,this.textSelected=null,this.textPasted=null,this.previousSelection=null,this.charCode=null,this.inputValue=null,this.from=this.to={line:null,ch:null,x:null,y:null},this.inverted=null,this.create(),this.undomanager=new UndoManager,this.hideCursor(),this.setLayout(),this.setTab(),this.addLines(lines),this.addEvents()};Extend(Editor.prototype,{create:function(){var template='<section class="editor"><header></header><section class="view"><div class="wrapper"><section class="body"><aside class="measure"></aside><aside class="selection"><mark></mark><mark></mark><mark></mark></aside><article class="content"></article><div class="cursor"></div><textarea class="input" autocorrect="off" autocapitalize="off" wrap="off"></textarea></section></div></section><footer></footer></section>',doc=document.createElement("div");doc.innerHTML=template,editor=doc.firstChild,header=editor.firstChild,footer=editor.lastChild,view=header.nextSibling,wrapper=view.firstChild,body=wrapper.firstChild,measure=body.firstChild,selection=measure.nextSibling,selectionTop=selection.firstChild,selectionMiddle=selectionTop.nextSibling,selectionBottom=selection.lastChild,content=selection.nextSibling,cursor=content.nextSibling,input=cursor.nextSibling,this.editor=editor,this.element={header:header,footer:footer,view:view,wrapper:wrapper,body:body,measure:measure,selection:selection,selectionTop:selectionTop,selectionMiddle:selectionMiddle,selectionBottom:selectionBottom,content:content,cursor:cursor,input:input},document.body.appendChild(this.editor)},setLayout:function(max_line){var option=this.options,measure=this.element.measure,wrapper=this.element.wrapper,content=this.element.content,tag=this.tag_container;measure.innerHTML="<"+tag+">m</"+tag+">";var text=measure.firstChild;option.max_line=max_line=max_line||option.max_line,this.width=text.offsetWidth*max_line,this.line_height=text.offsetHeight,this.em_width=text.offsetWidth,this.padding=option.padding_length*this.em_width,this.padding_width=2*this.padding,wrapper.style.width=this.width+this.padding_width+"px",wrapper.style.padding=this.line_height+"px 0",content.style.padding="0 "+this.padding+"px"},setTab:function(){var measure=this.element.measure,tag=this.tag_container;measure.innerHTML="<"+tag+'><span class="tab">&Tab;</span></'+tag+">";var content=measure.firstChild;this.tab_width=content.offsetWidth}}),Extend(Editor.prototype,{addEvents:function(){var el=this.element;view=el.view,input=el.input,Event.on(view,"mousedown",this.onMouseDown.bind(this)),Event.on(view,"selectstart",Event.preventDefault),Event.on(input,"keyup",this.onKeyUp.bind(this)),Event.on(input,"input",this.onInput.bind(this)),Event.on(input,"keydown",this.onKeyDown.bind(this)),Event.on(input,"focus",this.onFocus.bind(this)),Event.on(input,"blur",this.onBlur.bind(this)),Event.on(input,"paste",this.onPaste.bind(this))},onFocus:function(){this.focused||(this.focused=!0,this.editor.classList.add("focused")),this.blinkCursor()},onBlur:function(){this.focused&&(this.focused=!1,this.editor.classList.remove("focused")),this.save(),this.hideCursor();var self=this;setTimeout(function(){self.focused||self.setShift()},150)},onMouseDown:function(e){var last,going,self=this,view=this.element.view.getBoundingClientRect(),line=this.from.line,y=e.y>=view.bottom-10?e.y-10:e.y,start=this.getPosition(e.x,y);if(this.setShift(e.shiftKey),e.target.classList.contains("todo"))return this.toggleToDo(start,start),Event.preventDefault(e);this.focused||this.onFocus();var now=+new Date;if(this.lastDoubleClick&&this.lastDoubleClick.time>now-400&&Range.equal(this.lastDoubleClick.position,start))return Event.preventDefault(e),this.selectLine(start);if(this.lastClick&&this.lastClick.time>now-400&&Range.equal(this.lastClick.position,start))return this.lastDoubleClick={time:now,position:start},Event.preventDefault(e),this.selectWordAt(start);this.lastClick={time:now,position:start},Event.preventDefault(e),this.updateCursor(start,start),last=start,start=this.shiftSelecting||start,this.previousSelection=null,this.updateSelection(start,last);var mousemove=function(e){var end,element=self.element.view;e.y<=view.top+10?(end=last,0!==element.scrollTop&&(element.scrollTop-=self.line_height,going=setTimeout(function(){mousemove(e)},150),end=0===element.scrollTop?self.getPositionFromChar(1,0):self.getPosition(e.x,view.top+10))):e.y>=view.bottom-10?(end=last,element.scrollHeight-element.offsetHeight!==element.scrollTop&&(element.scrollTop+=self.line_height,end=self.getPosition(e.x,view.bottom-10),going=setTimeout(function(){mousemove(e)},150))):end=self.getPositionFromEvent(e),last=end,self.updateSelection(start,end)},move=Event.on(this.element.view,"mousemove",function(e){clearTimeout(going),Event.preventDefault(e),mousemove(e)},!0),up=Event.on(window,"mouseup",function(e){if(clearTimeout(going),Event.preventDefault(e),self.focusmode){self.getLine(line).classList.remove("active"),self.editor.classList.add("focusmode");var mouseWheel=Event.on(self.element.view,"mousewheel",function(){self.onMouseWheel(),mouseWheel()},!0)}self.updateView(self.from,self.to),self.focusInput(),move(),up()},!0)},onMouseWheel:function(){this.getLine(this.selectionStart().line).classList.remove("active"),this.editor.classList.remove("focusmode")},onKeyDown:function(e){this.focused||this.focusInput();var bound,dropShift,code=keyBindings.keyNames[e.keyCode];if(this.setShift(16==e.keyCode||e.shiftKey),null==code||e.altGraphKey)return null;if(e.altKey&&(code="alt+"+code),e.ctrlKey&&(code=(mac?"ctrl":"super")+"+"+code),e.metaKey&&(code="super+"+code),e.shiftKey&&(bound=keyBindings.bind["shift+"+code])?dropShift=!0:bound=keyBindings.bind[code],"string"==typeof bound&&(bound=this[bound].bind(this)),!bound)return!1;if(dropShift){var prevShift=this.shiftSelecting;this.shiftSelecting=null,bound(),this.shiftSelecting=prevShift}else bound();Event.preventDefault(e)},onInput:function(){var self=this;setTimeout(function(){self.add()},5)},onKeyUp:function(e){16==e.keyCode?this.shiftSelecting=null:this.textPasted=null},onPaste:function(){this.textPasted=!0}});var keyBindings={bind:{left:"goCharLeft",right:"goCharRight",up:"goLineUp",down:"goLineDown",end:"goLineEnd",home:"goDocStart",pageUp:"goPageUp",pageDown:"goPageDown","delete":"delCharRight",backspace:"delCharLeft",tab:"indentMore","shift+tab":"indentLess",enter:"newlineAndIndent",insert:"toggleOverwrite","super+d":"toggleFocusMode","super+a":"selectAll","super+z":"undo","shift+super+z":"redo","super+y":"redo","super+up":"goDocStart","super+end":"goDocEnd","super+down":"goDocEnd","alt+left":"goWordLeft","alt+right":"goWordRight","super+left":"goLineStart","super+right":"goLineEnd","alt+up":"goLineStart","alt+down":"goLineEnd","alt+backspace":"delWordLeft","ctrl+alt+backspace":"delWordRight","super+backspace":"deleteLine","alt+delete":"delWordRight","super+s":"save","super+f":"find","super+g":"findNext","shift+super+g":"findPrev","super+alt+f":"replace","shift+super+alt+f":"replaceAll","super+f":"toggleFullScreen","super+b":"makeStrong","super+i":"makeEmphasis","super+u":"makeDelete","super+l":"toggleToDo","Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageUp","Shift-Ctrl-V":"goPageDown","Ctrl-D":"delCharRight","Ctrl-H":"delCharLeft","Alt-D":"delWordRight","Alt-Backspace":"delWordLeft","Ctrl-K":"killLine","Ctrl-T":"transposeChars"},windows:{"super+left":"goWordLeft","super+right":"goWordRight","alt+left":"goLineStart","alt+right":"goLineEnd","super+home":"goDocStart","alt+up":"goDocStart","super+delete":"delWordRight","shift+super+f":"replace","shift+super+r":"replaceAll"},smartTypingPairs:{'"':'"',"(":")","{":"}","[":"]","<":">","`":"`"}};if(win)for(var command in keyBindings.windows)keyBindings.bind[command]=keyBindings.windows[command];var keyNames={3:"enter",8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capsLock",27:"esc",32:"space",33:"pageUp",34:"pageDown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",44:"printScrn",45:"insert",46:"delete",59:";",91:"mod",92:"mod",93:"mod",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63276:"pageUp",63277:"pageDown",63275:"end",63273:"home",63234:"left",63232:"up",63235:"right",63233:"down",63302:"insert",63272:"delete"};keyBindings.keyNames=keyNames,function(){for(var i=0;10>i;i++)keyNames[i+48]=String(i);for(var i=65;90>=i;i++)keyNames[i]=String.fromCharCode(i).toLowerCase();for(var i=1;12>=i;i++)keyNames[i+111]=keyNames[i+63235]="f"+i}(),Extend(Editor.prototype,{addLines:function(lines){lines=this.parserLines(lines),this.element.content.appendChild(lines)},replaceLines:function(from,to,lines){var parent=this.element.content;if(lines=this.parserLines(lines),from===to)parent.replaceChild(lines,this.getLine(from));else{for(var next,line=this.getLine(from),end=to-from+1;end--;)next=line.nextSibling,parent.removeChild(line),line=next;line?parent.insertBefore(lines,line):parent.appendChild(lines)}},updateView:function(from,to){if(this.focusmode){var line=this.getLine(this.from.line);line&&line.classList.remove("active"),this.getLine(from.line).classList.add("active")}this.updateSelection(from,to),this.updateCursor(from,to),this.updateInput()},getSize:function(){return this.element.content.childNodes.length},getLine:function(line){return this.element.content.childNodes[line-1]},getText:function(from,to){var line,text,i;if(line=this.getLine(from),text=[line.textContent],from!=to)for(i=from;to>i;)line=line.nextSibling,text.push(line.textContent),++i;return text.join("\n")},getContent:function(from,to){var line,text,i,value,offset=0;if(line=this.getLine(from.line),text=[line.textContent],!Range.line(from,to))for(i=from.line;i<to.line;)offset+=line.textContent.length,line=line.nextSibling,text.push(line.textContent),++i;return value={textContent:text.join("\n"),selectionStart:from.ch,selectionEnd:offset+to.ch+text.length-1},value.chunk=[value.textContent.slice(0,value.selectionStart),value.textContent.slice(value.selectionStart,value.selectionEnd),value.textContent.slice(value.selectionEnd)],value},getPositionFromPoint:function(x,y){var element=this.element,wrapper=element.wrapper,view=element.view;return x+=wrapper.getBoundingClientRect().left,y+=view.getBoundingClientRect().top+8,y-=view.scrollTop-parseInt(wrapper.style.paddingTop),this.getPosition(x,y)},getPositionFromEvent:function(event){return this.getPosition(event.x,event.y)},getPositionFromChar:function(line,ch){var node,walker,size,content,range,position,x,y;for(node=this.getLine(line),walker=document.createTreeWalker(node,NodeFilter.SHOW_TEXT,null,!1),size=ch;walker.nextNode()&&(node=walker.currentNode,!(node.textContent.length>=size));)size-=node.textContent.length;range=document.createRange(),range.selectNodeContents(node),range.setStart(range.startContainer,size),range.setEnd(range.endContainer,size);var position,positions=range.getClientRects();position=positions.length>1?positions[1]:positions[0];var element=this.element,wrapper=element.wrapper,content=element.content,line_height=this.line_height;return x=position.left,y=Math.floor((position.top-content.getBoundingClientRect().top)/line_height),{line:line,ch:ch,x:x-wrapper.getBoundingClientRect().left,y:y*line_height}},getPosition:function(x,y){var range=document.caretRangeFromPoint(x,y);"cursor"===range.startContainer.className&&(this.hideCursor(),range=document.caretRangeFromPoint(x,y)),range.expand("character");for(var node=range.startContainer,ch=range.startOffset,tag=this.tag_container;node&&node.localName!=tag;)node.previousSibling?(ch+=node.previousSibling.textContent.length,node=node.previousSibling):node=node.parentNode;for(var line=0;node;)node=node.previousSibling,++line;var position,positions=range.getClientRects();if(positions.length>1)var position=positions[y>positions[0].bottom?1:0];else var position=positions[0];var element=this.element,wrapper=element.wrapper,content=element.content,line_height=this.line_height;return x=position.left,y=Math.floor((position.top-content.getBoundingClientRect().top)/line_height),{line:line,ch:ch,x:x-wrapper.getBoundingClientRect().left,y:y*line_height}},findWord:function(position){for(var line=this.getLine(position.line).textContent,start=position.ch,end=position.ch;start>0&&Range.isWordChar(line.charAt(start-1));)--start;for(;end<line.length&&Range.isWordChar(line.charAt(end));)++end;var from=this.getPositionFromChar(position.line,start),to=this.getPositionFromChar(position.line,end);return{from:from,to:to}},findPoint:function(point,dir,unit){function findNextLine(){for(var l=line+dir,e=0>dir?0:size;l!=e;l+=dir)return line=l,node=self.getLine(line),!0}function moveOnce(boundToLine){if(ch==(0>dir?0:node.textContent.length)){if(boundToLine||!findNextLine())return!1;ch=0>dir?node.textContent.length:0}else ch+=dir;return!0}var node,self=this,line=point.line,ch=point.ch,size=this.getSize()+1;if(node=this.getLine(line),"char"==unit)moveOnce();else if("column"==unit)moveOnce(!0);else if("word"==unit)for(var sawWord=!1;!(0>dir)||moveOnce();){if(Range.isWordChar(node.textContent.charAt(ch)))sawWord=!0;else if(sawWord){0>dir&&(dir=1,moveOnce());break}if(dir>0&&!moveOnce())break}return this.getPositionFromChar(line,ch,dir)},moveHorizontalPoint:function(dir,unit){var from=this.from,to=this.to,position=to;position=this.shiftSelecting||Range.equal(from,to)?this.findPoint(position,dir,unit):Range.less(from,to)?0>dir?from:to:0>dir?to:from,this.updateView(this.shiftSelecting?this.from:position,position),this.previousSelection=null},moveVerticalPoint:function(dir,unit){var distance=0,from=this.from,to=this.to,position=to;if("page"==unit?distance=scroller.clientHeight:"line"==unit&&(distance=this.line_height),this.shiftSelecting||Range.equal(from,to)){null!=this.previousSelection&&(to.x=this.previousSelection);var copyCursor=Range.copy(to);copyCursor.y=to.y+distance*dir,this.updateCursor(copyCursor,copyCursor),position=this.getPositionFromPoint(to.x,copyCursor.y)}else position=Range.less(from,to)?0>dir?from:to:0>dir?to:from;this.updateView(this.shiftSelecting?this.from:position,position),this.previousSelection=to.x},removePoint:function(dir,unit){var position,node,del,line,value=this.getInputValue(!0),from=this.selectionStart(),to=this.selectionEnd();if(this.focusmode)var scrollH=this.element.content.offsetHeight,scrollT=this.element.view.scrollTop;if(Range.equal(from,to)?0>dir?(position=this.findPoint(from,dir,unit),from=position,line=this.getContent(from,to),node=line.textContent,del=node.slice(line.selectionStart,line.selectionEnd),value=node.slice(0,line.selectionStart)+value[2]):(position=this.findPoint(from,dir,unit),to=position,line=this.getContent(from,to),node=line.textContent,del=node.slice(line.selectionStart,line.selectionEnd),value=value[0]+node.slice(line.selectionEnd)):(del=value[1],value=value[0]+value[2],position=from),this.replaceLines(from.line,to.line,value),position=this.getPositionFromChar(position.line,position.ch),this.addHistory({add:"",del:del,textSelected:this.textSelected?to:null,from:from,to:position}),this.focusmode){var newScrollH=this.element.content.offsetHeight;scrollH!=newScrollH&&(this.element.view.scrollTop=scrollT+newScrollH-scrollH)}this.updateView(position,position)},goCharLeft:function(){this.moveHorizontalPoint(-1,"char")},goCharRight:function(){this.moveHorizontalPoint(1,"char")},goLineUp:function(){this.moveVerticalPoint(-1,"line")},goLineDown:function(){this.moveVerticalPoint(1,"line")},goLineStart:function(){var position,start=this.selectionStart();position=this.getPositionFromPoint(-this.padding,start.y),this.updateView(this.shiftSelecting?this.from:position,position)},goLineEnd:function(){var position,start=this.selectionStart();position=this.getPositionFromPoint(this.width,start.y),this.updateView(this.shiftSelecting?this.from:position,position)},goLineStartSmart:function(){},goPageUp:function(){},goPageDown:function(){},goDocStart:function(){var position=this.getPositionFromChar(1,0);this.updateView(this.shiftSelecting?this.from:position,position)},goDocEnd:function(){var position,line,size=this.getSize();line=this.getLine(size),position=this.getPositionFromChar(size,line.textContent.length),this.updateView(this.shiftSelecting?this.from:position,position)},goWordLeft:function(){this.moveHorizontalPoint(-1,"word")},goWordRight:function(){this.moveHorizontalPoint(1,"word")},delCharRight:function(){this.removePoint(1,"char")},delCharLeft:function(){this.removePoint(-1,"char")},delWordLeft:function(){this.removePoint(-1,"word")},delWordRight:function(){this.removePoint(1,"word")},deleteLine:function(){},indent:function(dir,from,to,noHistory){for(var start=dir,end=dir,line=this.getLine(from.line),i=to.line-from.line+1,lines=[];i--;)0>dir?lines.push(line.textContent.replace(/^\t/,"")):lines.push("	"+line.textContent),line=line.nextSibling;0>dir&&(start=this.getLine(from.line).textContent===lines[0]?0:dir,end=this.getLine(to.line).textContent===lines[lines.length-1]?0:dir),this.replaceLines(from.line,to.line,lines),Range.equal(from,to)?from=to=this.getPositionFromChar(this.from.line,this.from.ch+start):(from=this.getPositionFromChar(this.from.line,this.from.ch+start),to=this.getPositionFromChar(this.to.line,this.to.ch+end)),noHistory||0==start||0==end||this.addHistory({action:"indent",dir:dir,from:from,to:to}),this.updateView(from,to)},indentMore:function(){var from=this.selectionStart(),to=this.selectionEnd();this.indent(1,from,to)},indentLess:function(){var from=this.selectionStart(),to=this.selectionEnd();this.indent(-1,from,to)},newlineAndIndent:function(){var start,value=this.inputValue.chunk,from=this.selectionStart(),to=this.selectionEnd(),line=from.line+1,ch=0,add="\n",del=this.textSelected;if(value.splice(1,1),this.options.smartNewline&&(start=Parser.newline(value[0]),start[0]&&!this.shiftSelecting)){if(value[0]==start[0]&&!value[1]&&!this.textSelected){value="",line=from.line,del=start[0],this.replaceLines(line,to.line,value);var position=this.getPositionFromChar(line,0);return this.addHistory({action:"newline",add:"",del:del,textSelected:null,from:position,to:to}),this.updateView(position,position),void 0}value[1]=start[1]+value[1],ch=start[1].length,add+=start[1]}this.replaceLines(from.line,to.line,value);var position=this.getPositionFromChar(line,ch);this.addHistory({action:"newline",add:add,del:del,textSelected:this.textSelected?to:null,from:from,to:position}),this.focusmode&&(this.element.view.scrollTop=this.element.view.scrollTop+this.line_height),this.updateView(position,position)},add:function(){var add,value=this.getInputValue(),from=this.selectionStart(),to=this.selectionEnd(),line=from.line,ch=this.element.input.selectionEnd,textPasted=!1;if(this.focusmode)var scrollH=this.element.content.offsetHeight,scrollT=this.element.view.scrollTop;if(this.textPasted)textPasted=!0,add=value.slice(this.inputValue.chunk[0].length,ch),value=value.split(/\r?\n/),line=line+value.length-1,ch=value[value.length-1].length-this.inputValue.chunk[2].length;else if(this.options.smartTypingPairs){add=value.slice(from.ch,ch);var end=keyBindings.smartTypingPairs[add];if(end)return this.smartTyping(from,to,add,end,!1)}else add=value.slice(from.ch,ch);this.replaceLines(from.line,to.line,value);var position=this.getPositionFromChar(line,ch);if(this.addHistory({add:add,del:this.textSelected,textSelected:this.textSelected?to:null,from:from,to:position}),this.focusmode){var newScrollH=this.element.content.offsetHeight;scrollH!=newScrollH&&(this.element.view.scrollTop=scrollT+newScrollH-scrollH)}this.updateView(position,position)},smartTyping:function(from,to,open,close,select,noHistory){if(this.shiftSelecting&&Range.equal(from,to)){var positions=this.findWord(to);from=positions.from,to=positions.to}var _from=Range.copy(from),_to=Range.copy(to),value=this.getContent(from,to),textSelected=value.chunk[1];value=value.chunk[0]+open+value.chunk[1]+close+value.chunk[2],this.replaceLines(from.line,to.line,value),Range.equal(from,to)?from=to=this.getPositionFromChar(from.line,from.ch+open.length):select?(to=this.getPositionFromChar(to.line,to.ch+(Range.line(from,to)?open.length:0)),from=this.getPositionFromChar(from.line,from.ch+open.length)):from=to=this.getPositionFromChar(to.line,to.ch+(Range.line(from,to)?open.length:0)+close.length),noHistory||this.addHistory({action:"smartTyping",textSelected:textSelected,undo:{from:_from,to:_to},from:from,to:to,open:open,close:close,select:select}),this.updateView(from,to)},makeStrong:function(){var from=this.selectionStart(),to=this.selectionEnd();this.smartTyping(from,to,"**","**",!1)},makeEmphasis:function(){var from=this.selectionStart(),to=this.selectionEnd();this.smartTyping(from,to,"*","*",!1)},makeDelete:function(){var from=this.selectionStart(),to=this.selectionEnd();this.smartTyping(from,to,"-","-",!1)},selectWordAt:function(position){var positions=this.findWord(position);this.updateView(positions.from,positions.to)},selectLine:function(position){var from=this.getPositionFromPoint(0,position.y),to=this.getPositionFromPoint(this.width+this.padding,position.y);this.updateView(from,to)},undo:function(){var undo=this.getUndo();if(undo){var action=undo.action||"";if("indent"==action)this.indent(undo.dir<0?1:-1,undo.from,undo.to,!0);else if("smartTyping"==action){var from=undo.from,to=undo.to,line=this.getContent(from,to),remove=undo.open.length+undo.close.length,word=undo.textSelected.length+remove,value=line.textContent.splice(line.selectionStart-(undo.textSelected?word:undo.open.length),undo.textSelected?word:remove,undo.textSelected);this.replaceLines(from.line,to.line,value),this.updateView(undo.undo.from,undo.undo.to)}else if("todo"==action)this.toggleToDo(undo.from,undo.to,!0);else if(undo.textSelected){var from=undo.from,to=undo.to,line=this.getContent(from,to),value=line.textContent.splice(line.selectionStart,undo.add.length,undo.del);this.replaceLines(from.line,to.line,value),this.updateView(from,undo.textSelected)}else if(""==undo.add){var from=undo.from,to=undo.to,line=this.getContent(from,from),value=line.textContent.splice(line.selectionStart,"",undo.del);this.replaceLines(from.line,from.line,value),this.updateView(to,to)}else{var from=undo.from,to=undo.to,line=this.getContent(from,to),value=line.textContent.splice(line.selectionStart,undo.add.length,"");this.replaceLines(from.line,to.line,value),this.updateView(from,from)}}},redo:function(){var redo=this.getRedo();if(redo){var action=redo.action||"";if("indent"==action)this.indent(redo.dir,redo.from,redo.to,!0);else if("smartTyping"==action)this.smartTyping(redo.undo.from,redo.undo.to,redo.open,redo.close,redo.select,!0);else if("todo"==action)this.toggleToDo(redo.from,redo.to,!0);else if(redo.textSelected){var from=redo.from,to=redo.to,line=this.getContent(from,redo.textSelected),value=line.textContent.splice(line.selectionStart,redo.del.length,redo.add);this.replaceLines(from.line,redo.textSelected.line,value),this.updateView(to,to)}else if(""==redo.add){var from=redo.from,to=redo.to,line=this.getContent(from,to),value=line.textContent.splice(line.selectionStart,redo.del.length,"");this.replaceLines(from.line,to.line,value),this.updateView(from,from)}else{var from=redo.from,to=redo.to,line=this.getContent(from,from),value=line.textContent.splice(line.selectionStart,"",redo.add);this.replaceLines(from.line,from.line,value),this.updateView(to,to)}}},selectAll:function(){var size=this.getSize(),line=this.getLine(size),from=this.getPositionFromChar(1,0),to=this.getPositionFromChar(size,line.textContent.length);this.updateView(from,to)},toggleToDo:function(from,to,noHistory){from=from||this.selectionStart(),to=to||this.selectionEnd();for(var text,ch,value,replace,line=this.getLine(from.line),i=to.line-from.line+1,lines=[];i--;)text=line.textContent,ch=text[0],value=text.slice(1),"+"==ch||"-"==ch?(replace=!0,lines.push(("+"==ch?"-":"+")+value)):lines.push(text),line=line.nextSibling;replace&&(noHistory||this.addHistory({action:"todo",from:from,to:to}),this.replaceLines(from.line,to.line,lines),this.updateInput())},toggleFocusMode:function(){var wrapper=(this.element,this.element.wrapper),view=this.element.view,line_height=this.line_height;if(this.focusmode){this.focusmode=null,this.onMouseWheel();var offsetTop=parseInt(wrapper.style.paddingTop)-line_height;wrapper.style.padding=line_height+"px 0",view.scrollTop=this.selectionStart().y-offsetTop}else{this.focusmode=!0,this.editor.classList.add("focusmode");var lines=Math.floor(view.getBoundingClientRect().height/2/line_height)*line_height;wrapper.style.padding=lines+"px 0";var from=this.selectionStart();view.scrollTop=from.y;var onMouseWheel=this.onMouseWheel.bind(this),mouseWheel=Event.on(view,"mousewheel",function(){onMouseWheel(),mouseWheel()},!0);this.getLine(from.line).classList.add("active")}},save:function(){var save=this.options.localStorage;localStorage[save]=this.getText(1,this.getSize())}}),Extend(Editor.prototype,{blinkCursor:function(){var cursor=this.element.cursor.style;cursor.webkitAnimationName="none",setTimeout(function(){cursor.webkitAnimationName=""},10)},hideCursor:function(){this.element.cursor.style.display="none"},updateCursor:function(from,to){this.setCursor(to.x,to.y),this.element.cursor.scrollIntoViewIfNeeded(),Range.equal(from,to)?this.blinkCursor():this.hideCursor()},setCursor:function(x,y){var style=this.element.cursor.style,input=this.element.input;style.top=y+"px",style.left=x-2+"px",style.display="",input.style.top=y+"px",input.style.left=x+1+"px"}}),Extend(Editor.prototype,{focusInput:function(){this.element.input.focus()},blurInput:function(){this.element.input.blur()},updateInput:function(){var line,from=this.selectionStart(),to=this.selectionEnd();this.inputValue=line=this.getContent(from,to),this.element.input.value=line.textContent,this.setInputSelection(line.selectionStart,line.selectionEnd)},setInputSelection:function(start,end){var element=this.element.input;element.selectionStart=start,element.selectionEnd=end,this.textSelected=this.inputValue.chunk[1]},setInputValue:function(value){this.element.cursor.value=value},getInputValue:function(chunk){var element=this.element.input,value=element.value;return chunk?[value.slice(0,element.selectionStart),this.textSelected,value.slice(element.selectionEnd)]:value},getInputValueCached:function(){return this.inputValue},setShift:function(value){this.shiftSelecting=value?this.shiftSelecting||this.selectionStart():null},hasInputSelection:function(){try{var element=this.element.input;return element.selectionStart!=element.selectionEnd}catch(e){return!1}}}),Extend(Editor.prototype,{selectionStart:function(){return this.inverted?this.to:this.from},selectionEnd:function(){return this.inverted?this.from:this.to},updateSelection:function(from,to,highlight){this.from=from,this.to=to,this.inverted=!1,Range.equal(from,to)?this.inverted=!1:(from.y>to.y||from.y===to.y&&from.x>to.x)&&(this.inverted=!0),0!=highlight&&(this.inverted&&(from=this.to,to=this.from),this.setSelection(from,to))},setSelection:function(from,to){var element=this.element,top=element.selectionTop.style,middle=element.selectionMiddle.style,bottom=element.selectionBottom.style,line_height=this.line_height;if(top.width=middle.width=bottom.width=0,!Range.equal(from,to)){if(from.y==to.y)top.top=from.y+"px",top.left=from.x+"px",top.width=Math.abs(to.x-from.x)+"px",top.height=line_height+"px";else{top.top=from.y+"px",top.left=from.x+"px",top.width=this.width-from.x+this.padding_width+"px",top.height=line_height+"px";var lines=(to.y-from.y)/line_height;lines>1?(middle.top=from.y+line_height+"px",middle.left=0,middle.width=this.width+this.padding_width+"px",middle.height=to.y-from.y-line_height+"px"):middle.width=0,bottom.top=to.y+"px",bottom.left=0,bottom.width=to.x+"px",bottom.height=line_height+"px"}this.hideCursor()}}}),Editor.prototype.parserLines=function(lines){"string"==typeof lines&&(lines=lines.split(/\r?\n/)),lines=lines.slice();for(var line,value,fragment=document.createDocumentFragment();lines.length;)value=lines.shift(),line=Parser.line(value,this.tag_container,this.tab_width,this.em_width),fragment.appendChild(line);return fragment};var Parser={tab:/^(\t+)(.*)/,header:/^(#{1,}\s)(.*)/,blockquote:/^((>\s)+)(.*)/,list:/^([*+-]\s|\d+\.\s)(.*)/,strong:/^(__)(?=\S)([^\0]*?\S)(__)(?!_)|^(\*\*)(?=\S)([^\0]*?\S)(\*\*)(?!\*)/,em:/^(_)(?=\S)([^\0]*?\S)(_)(?!_)|^(\*)(?=\S)([^\0]*?\S)(\*)(?!\*)/,del:/^(-)(?=\S)([^\0]*?\S)(-)(?!-)/,text:/^[^\0]+?(?=[_*-]|$)/,pre:document.createElement("pre"),escape:function(str){return Parser.pre.textContent=str,Parser.pre.innerHTML},line:function(text,tag,tab_width,em_width){var match,line,value,width;if(line=document.createElement(tag),(match=Parser.tab.exec(text))&&(line.classList.add("code"),width=match[1].length*tab_width,line.style.marginLeft=width+"px",value='<span class="tab" style="margin-left:-'+width+'px;">'+match[1]+"</span>"+Parser.inline(match[2])),(match=Parser.header.exec(text))&&(line.classList.add("header"),width=match[1].length*em_width,value='<span style="margin-left:-'+width+'px;">'+match[1]+"</span>"+"<strong>"+Parser.inline(match[2])+"</srong>"),(match=Parser.blockquote.exec(text))&&(line.classList.add("blockquote"),width=match[1].length*em_width,line.style.marginLeft=width+"px",value='<span style="margin-left:-'+width+'px;">'+match[1]+"</span>"+Parser.inline(match[3])),match=Parser.list.exec(text)){line.classList.add("list"),width=match[1].length*em_width;var todo="+ "==match[1]||"- "==match[1]?'<span class="todo">'+match[1][0]+"</span> ":match[1];value="+ "==match[1]?'<span style="margin-left:-'+width+'px;">'+todo+"</span><del>"+Parser.inline(match[2])+"</del>":'<span style="margin-left:-'+width+'px;">'+todo+"</span>"+Parser.inline(match[2])}return line.classList.length||(line.classList.add("paragraph"),value=Parser.inline(text)),line.innerHTML=value,line},inline:function(text){for(var match,value,tag,line=[];text;)(match=Parser.strong.exec(text))?(tag=match[1]||match[4],value=tag+"<strong>"+Parser.escape(match[2]||match[5])+"</strong>"+tag,line.push(value),text=text.slice(match[0].length)):(match=Parser.em.exec(text))?(tag=match[1]||match[4],value=tag+"<em>"+Parser.escape(match[2]||match[5])+"</em>"+tag,line.push(value),text=text.slice(match[0].length)):(match=Parser.del.exec(text))?(value="-<del>"+Parser.escape(match[2])+"</del>-",line.push(value),text=text.slice(match[0].length)):(match=Parser.text.exec(text))&&(line.push(Parser.escape(match[0])),text=text.slice(match[0].length));
return line.join("")},newline:function(text){var match,value="",newvalue="";return(match=Parser.tab.exec(text))&&(value=newvalue=match[1]),(match=Parser.list.exec(text))&&(value=newvalue=match[1],numeric=value.split("."),numeric.length>1&&(numeric[0]++,newvalue=numeric.join("."))),[value,newvalue]}};Extend(Editor.prototype,{addHistory:function(action){this.undomanager.add(action)},getUndo:function(){return this.undomanager.undo()},getRedo:function(){return this.undomanager.redo()}});var UndoManager=function(){this.undoStack=[],this.redoStack=[]};UndoManager.prototype={add:function(action){var lastAction=this.undoStack.pop()||null;if(lastAction){var push=lastAction.action||action.action||lastAction.textSelected||action.textSelected||action.del&&lastAction.add||action.add&&!lastAction.add||action.add&&!Range.equal(lastAction.to,action.from)||action.del&&!Range.equal(lastAction.from,action.to);if(push)this.undoStack.push(lastAction),this.undoStack.push(action);else if(lastAction){var combined=this.chain(lastAction,action);this.undoStack.push(combined)}}else this.undoStack.push(action);this.redoStack=[]},undo:function(){var action=this.undoStack.pop()||null;return action&&this.redoStack.push(action),action},redo:function(){var action=this.redoStack.pop()||null;return action&&this.undoStack.push(action),action},chain:function(action1,action2){var action={add:action1.add+action2.add,del:action2.del+action1.del,textPasted:null};return action.from=action.add?action1.from:action2.from,action.to=action.add?action2.to:action1.to,action}},"undefined"!=typeof define&&"function"==typeof define&&define.amd?define("webwriter",[],function(){return Editor}):window.Editor=Editor}();